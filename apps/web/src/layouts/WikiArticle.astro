---
/**
 * WikiArticle Layout - CSS Grid Based
 * Modern responsive layout with named grid areas
 * Replaces float-based infobox with proper grid placement
 */
import Layout from './Layout.astro';
import Infobox from '../components/Infobox.astro';
import TableOfContents from '../components/TableOfContents.astro';
import PasswordDialog from '../components/editor/PasswordDialog.astro';
import '../styles/editor.css';

interface MusicalConnections {
  collaborators?: string[];
  influenced?: string[];
  mentors?: string[];
}

interface ReverseConnections {
  collaboratedWith?: string[];
  influencedBy?: string[];
  mentoredBy?: string[];
}

interface Props {
  title: string;
  data: Record<string, unknown>;
  description?: string;
  ogImage?: string;
  ogType?: string;
  canonicalUrl?: string;
  headings?: { id: string; text: string }[];
  connections?: {
    forward?: MusicalConnections;
    reverse?: ReverseConnections;
  };
  artistSlug?: string;
}

const { title, data, description, ogImage, ogType, canonicalUrl, headings = [], connections, artistSlug } = Astro.props;

// Generate description from genres if not provided
const genres = (data.genres || []) as string[];
const instruments = (data.instruments || []) as string[];
const autoDescription = description || `${title} - ${genres.slice(0, 3).join(', ')} artist${instruments.length > 0 ? ` playing ${instruments.slice(0, 2).join(', ')}` : ''}`;
---

<Layout title={title} description={autoDescription} ogImage={ogImage} ogType={ogType} canonicalUrl={canonicalUrl}>
  <article class="wiki-article-grid">
    <!-- Article Header -->
    <header class="wiki-header">
      <h1 class="wiki-title">{title}</h1>
    </header>

    <!-- TOC Sidebar (left) -->
    <aside class="wiki-toc">
      <TableOfContents headings={headings} />
    </aside>

    <!-- Infobox (right) -->
    <aside class="wiki-infobox">
      <Infobox title={title} data={data} connections={connections} artistSlug={artistSlug} />
    </aside>

    <!-- Article Content -->
    <div class="wiki-content article-content prose prose-wiki">
      <slot />
    </div>
  </article>

  <!-- Password Dialog for Inline Editing -->
  <PasswordDialog />
</Layout>

<style>
  /* ============================================
     CSS Grid Layout for Wiki Articles
     Three-column layout with named grid areas
     ============================================ */

  .wiki-article-grid {
    display: grid;
    gap: 1.5rem;
    line-height: 1.65;
    color: var(--color-text);

    /* Mobile: Single column, stacked layout */
    grid-template-columns: 1fr;
    grid-template-areas:
      "header"
      "infobox"
      "toc"
      "content";
  }

  /* Tablet: Two columns, TOC hidden */
  @media (min-width: 768px) {
    .wiki-article-grid {
      grid-template-columns: 1fr 280px;
      grid-template-areas:
        "header header"
        "content infobox"
        "content .";
    }
  }

  /* Desktop: Three columns with TOC sidebar */
  @media (min-width: 1024px) {
    .wiki-article-grid {
      grid-template-columns: 180px 1fr 300px;
      grid-template-areas:
        "toc header header"
        "toc content infobox"
        "toc content .";
    }
  }

  /* Wide screens: Constrain max width */
  @media (min-width: 1280px) {
    .wiki-article-grid {
      grid-template-columns: 200px 1fr 320px;
    }
  }

  /* Grid area assignments */
  .wiki-header {
    grid-area: header;
  }

  .wiki-toc {
    grid-area: toc;
    display: none;
  }

  .wiki-infobox {
    grid-area: infobox;
  }

  .wiki-content {
    grid-area: content;
    min-width: 0; /* Prevent content overflow */
    max-width: var(--article-max-width, 48rem);
  }

  /* Show TOC on desktop */
  @media (min-width: 1024px) {
    .wiki-toc {
      display: block;
      position: sticky;
      top: 5rem;
      align-self: start;
      max-height: calc(100vh - 6rem);
      overflow-y: auto;
    }
  }

  /* Header styling */
  .wiki-title {
    font-family: 'Playfair Display Variable', Georgia, serif;
    font-size: 2rem;
    font-weight: 500;
    color: var(--color-text-heading);
    border-bottom: 2px solid var(--color-border-accent);
    padding-bottom: 0.5rem;
    margin: 0;
    letter-spacing: -0.01em;
  }

  /* ============================================
     Article Content Typography
     ============================================ */

  /* First paragraph styling (like Wikipedia lead) */
  .article-content :global(p:first-of-type) {
    font-size: 1.05rem;
  }

  /* Section headings */
  .article-content :global(h2) {
    font-family: 'Playfair Display Variable', Georgia, serif;
    font-size: 1.5rem;
    font-weight: 500;
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 0.25rem;
    margin-top: calc(2rem * var(--spacing-multiplier, 1));
    margin-bottom: calc(0.75rem * var(--spacing-multiplier, 1));
    color: var(--color-text-heading);
    scroll-margin-top: 5rem;
  }

  .article-content :global(h3) {
    font-family: 'Playfair Display Variable', Georgia, serif;
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: calc(1.5rem * var(--spacing-multiplier, 1));
    margin-bottom: calc(0.5rem * var(--spacing-multiplier, 1));
    color: var(--color-text-heading);
    scroll-margin-top: 5rem;
  }

  /* Paragraph spacing */
  .article-content :global(p) {
    margin-bottom: calc(1rem * var(--spacing-multiplier, 1));
    text-align: justify;
    color: var(--color-text);
    hyphens: auto;
  }

  /* Lists */
  .article-content :global(ul),
  .article-content :global(ol) {
    margin-bottom: calc(1rem * var(--spacing-multiplier, 1));
    padding-left: 1.5rem;
    color: var(--color-text);
  }

  .article-content :global(li) {
    margin-bottom: calc(0.25rem * var(--spacing-multiplier, 1));
  }

  /* Links with jazz underline effect */
  .article-content :global(a) {
    color: var(--color-link);
    text-decoration: none;
    transition: color var(--duration-fast) var(--ease-smooth);
  }

  .article-content :global(a:hover) {
    text-decoration: underline;
    text-decoration-color: var(--electric-cyan);
    text-underline-offset: 2px;
    color: var(--color-link-hover);
  }

  /* Tables */
  .article-content :global(table) {
    border-collapse: collapse;
    margin: calc(1rem * var(--spacing-multiplier, 1)) 0;
    width: 100%;
    font-size: 0.9rem;
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .article-content :global(th),
  .article-content :global(td) {
    border: 1px solid var(--color-border);
    padding: 0.5rem 0.75rem;
    text-align: left;
    color: var(--color-text);
  }

  .article-content :global(th) {
    background-color: var(--color-bg-nav);
    font-weight: 600;
    font-family: 'Playfair Display Variable', Georgia, serif;
  }

  .article-content :global(tr:nth-child(even)) {
    background-color: var(--color-bg);
  }

  /* Images in content */
  .article-content :global(img) {
    max-width: 100%;
    height: auto;
    display: none; /* Hide broken images by default */
  }

  /* Blockquotes */
  .article-content :global(blockquote) {
    border-left: 3px solid var(--color-accent);
    margin: calc(1rem * var(--spacing-multiplier, 1)) 0;
    padding: 0.75rem 1rem;
    background: var(--color-bg);
    font-style: italic;
    color: var(--color-text-secondary);
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  }

  /* Code blocks */
  .article-content :global(code) {
    font-family: 'JetBrains Mono Variable', monospace;
    background: var(--color-bg-nav);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.85em;
    color: var(--color-text);
  }

  .article-content :global(pre) {
    background: var(--color-bg-nav);
    padding: 1rem;
    overflow-x: auto;
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    color: var(--color-text);
  }

  .article-content :global(pre code) {
    background: none;
    padding: 0;
  }

  /* Horizontal rules */
  .article-content :global(hr) {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: calc(1.5rem * var(--spacing-multiplier, 1)) 0;
  }

  /* Mobile responsiveness */
  @media (max-width: 640px) {
    .wiki-title {
      font-size: 1.75rem;
    }

    .article-content :global(p) {
      text-align: left;
      hyphens: none;
    }
  }
</style>
