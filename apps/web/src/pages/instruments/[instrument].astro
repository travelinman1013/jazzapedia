---
/**
 * Instrument Detail Page - Show artists who play a specific instrument
 * Uses D1/SQLite database for SSR
 */
import Layout from '../../layouts/Layout.astro';
import { getDatabase } from '../../lib/db';

// Get database adapter (works with both D1 and SQLite)
const db = await getDatabase(Astro.locals);

// Set cache headers
Astro.response.headers.set('Cache-Control', 'public, max-age=3600, stale-while-revalidate=86400');

const { instrument: instrumentSlug } = Astro.params;

interface InstrumentInfo {
  id: number;
  name: string;
  slug: string;
  artist_count: number;
}

interface Artist {
  slug: string;
  title: string;
  artist_type: string | null;
  genres: string | null;
  instruments: string | null;
  image_filename: string | null;
  spotify_data: string | null;
}

let instrumentInfo: InstrumentInfo | null = null;
let artists: Artist[] = [];
let errorMessage = '';

if (!db) {
  return Astro.redirect('/instruments');
}

try {
  // Get instrument info from lookup table
  instrumentInfo = await db
    .prepare('SELECT id, name, slug, artist_count FROM instruments WHERE slug = ?')
    .bind(instrumentSlug)
    .first() as InstrumentInfo | null;

  if (!instrumentInfo) {
    return Astro.redirect('/instruments');
  }

  // Get artists with this instrument (JSON array contains)
  const { results } = await db
    .prepare(`
      SELECT slug, title, artist_type, genres, instruments, image_filename, spotify_data
      FROM artists
      WHERE instruments LIKE ?
      ORDER BY
        CASE WHEN json_extract(spotify_data, '$.popularity') IS NOT NULL
             THEN json_extract(spotify_data, '$.popularity')
             ELSE 0 END DESC,
        title ASC
      LIMIT 500
    `)
    .bind('%"' + instrumentInfo.name + '"%')
    .all();
  artists = results as Artist[];
} catch (error) {
  console.error('Error loading instrument:', error);
  errorMessage = 'Failed to load instrument data.';
}

// Helper functions
function parseJson(json: string | null, fallback: any): any {
  if (!json) return fallback;
  try {
    return JSON.parse(json);
  } catch {
    return fallback;
  }
}

const toSlug = (text: string) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');

// Calculate related instruments from artists
const relatedInstrumentCounts = new Map<string, number>();
artists.forEach(artist => {
  const instruments = parseJson(artist.instruments, []);
  instruments.forEach(i => {
    if (i !== instrumentInfo?.name) {
      relatedInstrumentCounts.set(i, (relatedInstrumentCounts.get(i) || 0) + 1);
    }
  });
});
const relatedInstruments = Array.from(relatedInstrumentCounts.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10);

// Get common genres for this instrument
const genreCounts = new Map<string, number>();
artists.forEach(artist => {
  const genres = parseJson(artist.genres, []);
  genres.forEach(genre => {
    genreCounts.set(genre, (genreCounts.get(genre) || 0) + 1);
  });
});
const topGenres = Array.from(genreCounts.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10);

// Calculate average popularity
const artistsWithPopularity = artists.filter(a => {
  const spotify = parseJson(a.spotify_data, {});
  return spotify.popularity !== undefined;
});
const avgPopularity = artistsWithPopularity.length > 0
  ? Math.round(
      artistsWithPopularity.reduce((sum, a) => {
        const spotify = parseJson(a.spotify_data, {});
        return sum + (spotify.popularity || 0);
      }, 0) / artistsWithPopularity.length
    )
  : 0;
---

<Layout title={instrumentInfo?.name || 'Instrument'}>
  <div class="article-content">
    {errorMessage ? (
      <p class="text-red-600">{errorMessage}</p>
    ) : instrumentInfo && (
      <>
        <h1>{instrumentInfo.name}</h1>

        <p class="text-wiki-text-secondary mb-6">
          <strong>{artists.length.toLocaleString()}</strong> artists play this instrument.
          {avgPopularity > 0 && (
            <> Average Spotify popularity: <strong>{avgPopularity}/100</strong>.</>
          )}
        </p>

        <!-- Instrument Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
          <!-- Related Instruments -->
          {relatedInstruments.length > 0 && (
            <div class="bg-wiki-bg border border-wiki-border rounded p-4">
              <h3 class="font-semibold mb-2 text-wiki-text">Often Played With</h3>
              <div class="flex flex-wrap gap-1">
                {relatedInstruments.map(([instrument, count]) => (
                  <a
                    href={`/instruments/${toSlug(instrument)}`}
                    class="inline-flex items-center px-2 py-1 bg-wiki-tag-bg border border-wiki-tag-border rounded text-xs hover:bg-wiki-accent-light transition-colors"
                  >
                    <span class="text-wiki-link">{instrument}</span>
                    <span class="ml-1 text-wiki-text-muted">({count})</span>
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- Top Genres -->
          {topGenres.length > 0 && (
            <div class="bg-wiki-bg border border-wiki-border rounded p-4">
              <h3 class="font-semibold mb-2 text-wiki-text">Common Genres</h3>
              <div class="flex flex-wrap gap-1">
                {topGenres.map(([genre, count]) => (
                  <a
                    href={`/genres/${toSlug(genre)}`}
                    class="inline-flex items-center px-2 py-1 bg-wiki-tag-bg border border-wiki-tag-border rounded text-xs hover:bg-wiki-accent-light transition-colors"
                  >
                    <span class="text-wiki-link">{genre}</span>
                    <span class="ml-1 text-wiki-text-muted">({count})</span>
                  </a>
                ))}
              </div>
            </div>
          )}
        </div>

        <!-- Artists List -->
        <h2>Artists ({artists.length})</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          {artists.map(artist => {
            const spotifyData = parseJson(artist.spotify_data, {});
            const artistInstruments = parseJson(artist.instruments, []);
            const otherInstruments = artistInstruments.filter(i => i !== instrumentInfo?.name).slice(0, 2);
            const genres = parseJson(artist.genres, []).slice(0, 2);

            return (
              <a
                href={`/artists/${artist.slug}`}
                class="block p-3 bg-wiki-bg border border-wiki-border-light rounded hover:border-wiki-link hover:bg-wiki-accent-light transition-colors"
              >
                <div class="flex items-start justify-between">
                  <span class="text-wiki-link font-medium">{artist.title}</span>
                  {spotifyData?.popularity && (
                    <span class="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded">
                      {spotifyData.popularity}
                    </span>
                  )}
                </div>
                {genres.length > 0 && (
                  <div class="text-xs text-wiki-text-muted mt-1 truncate">
                    {genres.join(', ')}
                  </div>
                )}
                {otherInstruments.length > 0 && (
                  <div class="text-xs text-wiki-text-muted mt-0.5 truncate">
                    Also plays: {otherInstruments.join(', ')}
                  </div>
                )}
              </a>
            );
          })}
        </div>

        <!-- Back Link -->
        <div class="mt-8 pt-4 border-t border-wiki-border">
          <a href="/instruments" class="text-wiki-link hover:underline">
            &larr; Back to all instruments
          </a>
        </div>
      </>
    )}
  </div>
</Layout>
