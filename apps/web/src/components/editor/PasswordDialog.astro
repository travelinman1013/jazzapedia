---
/**
 * PasswordDialog Component
 * Modal for entering the edit password
 * Password is verified against the server and token stored in sessionStorage
 */
---

<div id="password-dialog" class="pwd-backdrop" role="dialog" aria-modal="true" aria-labelledby="pwd-title">
  <div class="pwd-container">
    <div class="pwd-header">
      <h3 id="pwd-title" class="pwd-title">Enter Edit Password</h3>
      <button class="pwd-close" aria-label="Close" type="button">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
    </div>

    <div class="pwd-body">
      <p class="pwd-description">Enter the password to enable editing for this session.</p>

      <div class="pwd-input-wrapper">
        <input
          type="password"
          id="pwd-input"
          class="pwd-input"
          placeholder="Password"
          autocomplete="off"
        />
      </div>

      <div id="pwd-error" class="pwd-error" style="display: none;">
        Invalid password. Please try again.
      </div>
    </div>

    <div class="pwd-footer">
      <button id="pwd-cancel" class="pwd-btn pwd-btn-cancel" type="button">Cancel</button>
      <button id="pwd-submit" class="pwd-btn pwd-btn-submit" type="button">
        <span class="pwd-btn-text">Verify</span>
        <span class="pwd-btn-loading" style="display: none;">
          <span class="pwd-spinner"></span>
        </span>
      </button>
    </div>
  </div>
</div>

<style>
  /* Backdrop & Container */
  .pwd-backdrop {
    position: fixed;
    inset: 0;
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    opacity: 0;
    transition: opacity 0.15s ease-out;
  }

  .pwd-backdrop.is-open {
    display: flex;
    opacity: 1;
  }

  .pwd-container {
    width: 100%;
    max-width: 400px;
    margin: 0 1rem;
    background: var(--color-bg-content, #1a1a1a);
    border: 1px solid var(--color-border, #333);
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
    overflow: hidden;
    transform: scale(0.95);
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .pwd-backdrop.is-open .pwd-container {
    transform: scale(1);
  }

  /* Header */
  .pwd-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--color-border, #333);
    background: var(--color-bg-nav, #121212);
  }

  .pwd-title {
    margin: 0;
    font-family: 'Playfair Display Variable', Georgia, serif;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text, #e5e5e5);
  }

  .pwd-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border: none;
    background: transparent;
    color: var(--color-text-muted, #888);
    cursor: pointer;
    border-radius: 0.375rem;
    transition: all 0.15s ease-out;
  }

  .pwd-close:hover {
    background: var(--color-accent-light, rgba(0, 217, 255, 0.1));
    color: var(--color-text, #e5e5e5);
  }

  /* Body */
  .pwd-body {
    padding: 1.5rem 1.25rem;
  }

  .pwd-description {
    margin: 0 0 1rem;
    font-size: 0.875rem;
    color: var(--color-text-muted, #888);
  }

  .pwd-input-wrapper {
    display: flex;
    align-items: center;
    background: var(--color-bg-nav, #121212);
    border: 1px solid var(--color-border, #333);
    border-radius: 0.5rem;
    transition: border-color 0.15s ease-out;
  }

  .pwd-input-wrapper:focus-within {
    border-color: var(--electric-cyan, #00d9ff);
    box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.15);
  }

  .pwd-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: none;
    background: transparent;
    font-size: 1rem;
    font-family: inherit;
    color: var(--color-text, #e5e5e5);
    outline: none;
  }

  .pwd-input::placeholder {
    color: var(--color-text-muted, #888);
  }

  .pwd-error {
    margin-top: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: #ef4444;
  }

  /* Footer */
  .pwd-footer {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    padding: 1rem 1.25rem;
    border-top: 1px solid var(--color-border, #333);
    background: var(--color-bg-nav, #121212);
  }

  .pwd-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    font-family: inherit;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.15s ease-out;
    min-width: 5rem;
  }

  .pwd-btn-cancel {
    background: var(--color-bg-content, #1a1a1a);
    border: 1px solid var(--color-border, #333);
    color: var(--color-text, #e5e5e5);
  }

  .pwd-btn-cancel:hover {
    background: var(--color-accent-light, rgba(0, 217, 255, 0.1));
  }

  .pwd-btn-submit {
    background: var(--electric-cyan, #00d9ff);
    color: var(--jazz-charcoal, #1a1a1a);
  }

  .pwd-btn-submit:hover {
    background: var(--jazz-amber, #d4a254);
  }

  .pwd-btn-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .pwd-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid currentColor;
    border-top-color: transparent;
    border-radius: 50%;
    animation: pwd-spin 0.8s linear infinite;
  }

  @keyframes pwd-spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
  /**
   * PasswordDialog controller
   * Manages the password verification flow for inline editing
   */
  class PasswordDialog {
    private backdrop: HTMLElement;
    private input: HTMLInputElement;
    private submitBtn: HTMLButtonElement;
    private cancelBtn: HTMLButtonElement;
    private closeBtn: HTMLButtonElement;
    private error: HTMLElement;
    private btnText: HTMLElement;
    private btnLoading: HTMLElement;

    private resolvePromise: ((value: boolean) => void) | null = null;

    private static instance: PasswordDialog | null = null;

    static getInstance(): PasswordDialog {
      if (!PasswordDialog.instance) {
        PasswordDialog.instance = new PasswordDialog();
      }
      return PasswordDialog.instance;
    }

    constructor() {
      this.backdrop = document.getElementById('password-dialog')!;
      this.input = document.getElementById('pwd-input') as HTMLInputElement;
      this.submitBtn = document.getElementById('pwd-submit') as HTMLButtonElement;
      this.cancelBtn = document.getElementById('pwd-cancel') as HTMLButtonElement;
      this.closeBtn = this.backdrop.querySelector('.pwd-close') as HTMLButtonElement;
      this.error = document.getElementById('pwd-error')!;
      this.btnText = this.backdrop.querySelector('.pwd-btn-text')!;
      this.btnLoading = this.backdrop.querySelector('.pwd-btn-loading')!;

      this.bindEvents();
    }

    private bindEvents() {
      // Close on backdrop click
      this.backdrop.addEventListener('click', (e) => {
        if (e.target === this.backdrop) {
          this.cancel();
        }
      });

      // Close button
      this.closeBtn.addEventListener('click', () => this.cancel());

      // Cancel button
      this.cancelBtn.addEventListener('click', () => this.cancel());

      // Submit button
      this.submitBtn.addEventListener('click', () => this.submit());

      // Enter to submit
      this.input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          this.submit();
        } else if (e.key === 'Escape') {
          this.cancel();
        }
      });

      // Clear error on input
      this.input.addEventListener('input', () => {
        this.error.style.display = 'none';
      });
    }

    /**
     * Check if user is already authenticated for this session
     */
    static isAuthenticated(): boolean {
      const expiresAt = sessionStorage.getItem('jazzapedia_edit_expires');
      if (!expiresAt) return false;
      return Date.now() < parseInt(expiresAt, 10);
    }

    /**
     * Get stored token (for API calls)
     */
    static getToken(): string | null {
      if (!PasswordDialog.isAuthenticated()) return null;
      return sessionStorage.getItem('jazzapedia_edit_token');
    }

    /**
     * Clear authentication
     */
    static clearAuth() {
      sessionStorage.removeItem('jazzapedia_edit_token');
      sessionStorage.removeItem('jazzapedia_edit_expires');
    }

    /**
     * Open the dialog and return a promise that resolves when authenticated
     */
    async promptForPassword(): Promise<boolean> {
      // Already authenticated?
      if (PasswordDialog.isAuthenticated()) {
        return true;
      }

      return new Promise((resolve) => {
        this.resolvePromise = resolve;
        this.open();
      });
    }

    private open() {
      this.backdrop.classList.add('is-open');
      this.input.value = '';
      this.error.style.display = 'none';
      this.input.focus();
      document.body.style.overflow = 'hidden';
    }

    private close() {
      this.backdrop.classList.remove('is-open');
      document.body.style.overflow = '';
    }

    private cancel() {
      this.close();
      if (this.resolvePromise) {
        this.resolvePromise(false);
        this.resolvePromise = null;
      }
    }

    private async submit() {
      const password = this.input.value.trim();

      if (!password) {
        this.error.textContent = 'Please enter a password.';
        this.error.style.display = 'block';
        return;
      }

      // Show loading state
      this.submitBtn.disabled = true;
      this.btnText.style.display = 'none';
      this.btnLoading.style.display = 'inline-flex';

      try {
        const response = await fetch('/api/auth/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
        });

        const data = await response.json() as {
          success: boolean;
          token?: string;
          expiresAt?: number;
          error?: string;
        };

        if (data.success && data.token && data.expiresAt) {
          // Store auth state
          sessionStorage.setItem('jazzapedia_edit_token', data.token);
          sessionStorage.setItem('jazzapedia_edit_expires', data.expiresAt.toString());

          this.close();
          if (this.resolvePromise) {
            this.resolvePromise(true);
            this.resolvePromise = null;
          }
        } else {
          this.error.textContent = data.error || 'Invalid password. Please try again.';
          this.error.style.display = 'block';
          this.input.select();
        }
      } catch (err) {
        console.error('Password verification error:', err);
        this.error.textContent = 'Connection error. Please try again.';
        this.error.style.display = 'block';
      } finally {
        // Reset button state
        this.submitBtn.disabled = false;
        this.btnText.style.display = 'inline';
        this.btnLoading.style.display = 'none';
      }
    }
  }

  // Make available globally
  (window as any).PasswordDialog = PasswordDialog;

  // Initialize on DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    PasswordDialog.getInstance();
  });
</script>
