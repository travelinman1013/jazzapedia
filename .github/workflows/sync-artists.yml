name: Sync Artists to Jazzapedia

on:
  # Run when content-deploy changes are pushed
  push:
    branches: [main]
    paths:
      - 'apps/web/content-deploy/**'
  # Run daily at 5am Central Time (11:00 UTC) as backup
  schedule:
    - cron: '0 11 * * *'
  # Allow manual triggers
  workflow_dispatch:
    inputs:
      sync_d1:
        description: 'Sync artist data to D1 database'
        type: boolean
        default: true
      full_sync:
        description: 'Full sync (re-sync all artists, slower)'
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (preview only)'
        type: boolean
        default: false

jobs:
  sync-to-d1:
    name: Sync Artists to D1
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || inputs.sync_d1 }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm turbo build --filter=@jazzapedia/types --filter=@jazzapedia/db --filter=@jazzapedia/utils

      - name: Count artists to sync
        run: |
          ARTIST_COUNT=$(find apps/web/content-deploy/artists -name "*.md" 2>/dev/null | wc -l || echo "0")
          echo "Found $ARTIST_COUNT artist files to sync"

      - name: Sync to D1 (incremental)
        if: ${{ github.event_name == 'schedule' || !inputs.full_sync }}
        working-directory: apps/web
        run: pnpm exec tsx scripts/sync-incremental.ts --remote ${{ inputs.dry_run && '--dry-run' || '' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          ARTISTS_DIR: ./content-deploy/artists
          PORTRAITS_DIR: ./content-deploy/portraits

      - name: Sync to D1 (full)
        if: ${{ github.event_name != 'schedule' && inputs.full_sync }}
        working-directory: apps/web
        run: pnpm exec tsx scripts/sync-to-d1.ts --remote ${{ inputs.dry_run && '--dry-run' || '' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          ARTISTS_DIR: ./content-deploy/artists
          PORTRAITS_DIR: ./content-deploy/portraits

      - name: Import WWOZ SQL to D1
        if: ${{ github.event_name == 'schedule' }}
        working-directory: apps/web
        run: |
          if [ -f "scripts/.wwoz-export/wwoz-sync.sql" ]; then
            echo "Importing WWOZ SQL to D1..."
            npx wrangler d1 execute jazzapedia --remote --file="scripts/.wwoz-export/wwoz-sync.sql" --yes
            echo "WWOZ import complete"
          else
            echo "No WWOZ SQL file found - skipping import"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # NOTE: Portrait uploads are now handled directly from the local machine
  # via unified-daily-sync.sh which uploads to R2 before pushing to git.
  # The manifest file (.r2-uploaded-manifest.json) is stored locally in the
  # portraits directory and tracks what's been uploaded.
