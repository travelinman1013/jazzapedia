---
/**
 * TableOfContents Component - Enhanced with Active Section Tracking
 * Uses Intersection Observer to highlight the current section
 * Jazz club aesthetic with cyan accent for active states
 */

interface Props {
  headings: { id: string; text: string }[];
}

const { headings } = Astro.props;
---

{headings.length > 0 && (
  <nav class="toc" aria-label="Table of Contents">
    <!-- Mobile: Collapsible -->
    <details class="toc-mobile">
      <summary class="toc-summary">
        <span class="toc-summary-text">Contents</span>
        <svg class="toc-chevron" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </summary>
      <ol class="toc-list">
        {headings.map((h, i) => (
          <li>
            <a href={`#${h.id}`} class="toc-link" data-toc-link data-heading-id={h.id}>
              <span class="toc-number">{i + 1}</span>
              <span class="toc-text">{h.text}</span>
            </a>
          </li>
        ))}
      </ol>
    </details>

    <!-- Desktop: Always visible sidebar -->
    <div class="toc-desktop">
      <div class="toc-header">
        <span class="toc-title">Contents</span>
      </div>
      <ol class="toc-list">
        {headings.map((h, i) => (
          <li>
            <a href={`#${h.id}`} class="toc-link" data-toc-link data-heading-id={h.id}>
              <span class="toc-number">{i + 1}</span>
              <span class="toc-text">{h.text}</span>
            </a>
          </li>
        ))}
      </ol>
    </div>
  </nav>
)}

<style>
  .toc {
    font-size: 0.875rem;
    line-height: 1.4;
    color: var(--color-text);
  }

  /* ============================================
     Desktop Sidebar
     ============================================ */
  .toc-desktop {
    display: none;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .toc-header {
    padding: 0.75rem 1rem;
    background: var(--color-bg-nav);
    border-bottom: 1px solid var(--color-border);
  }

  .toc-title {
    font-family: 'Playfair Display Variable', Georgia, serif;
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-heading);
  }

  /* ============================================
     Mobile Collapsible
     ============================================ */
  .toc-mobile {
    display: block;
    border: 1px solid var(--color-border);
    background: var(--color-bg-card);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .toc-summary {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    cursor: pointer;
    background: var(--color-bg-nav);
    user-select: none;
    list-style: none;
  }

  .toc-summary::-webkit-details-marker {
    display: none;
  }

  .toc-summary-text {
    font-family: 'Playfair Display Variable', Georgia, serif;
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-heading);
  }

  .toc-chevron {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--color-text-muted);
    transition: transform var(--duration-fast) var(--ease-jazz);
  }

  .toc-mobile[open] .toc-chevron {
    transform: rotate(180deg);
  }

  .toc-mobile .toc-list {
    padding: 0.5rem;
    border-top: 1px solid var(--color-border-light);
  }

  /* ============================================
     TOC List Shared Styles
     ============================================ */
  .toc-list {
    list-style: none;
    padding: 0.75rem;
    margin: 0;
  }

  .toc-list li {
    margin: 0;
  }

  .toc-link {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    padding: 0.375rem 0.5rem;
    margin: 0.125rem 0;
    color: var(--color-text-secondary);
    text-decoration: none;
    border-radius: var(--radius-sm);
    border-left: 2px solid transparent;
    transition: all var(--duration-fast) var(--ease-smooth);
  }

  .toc-link:hover {
    color: var(--color-link);
    background: var(--color-accent-light);
    border-left-color: var(--color-accent);
  }

  /* Active state - highlighted with cyan */
  .toc-link.is-active {
    color: var(--electric-cyan);
    background: var(--color-accent-light);
    border-left-color: var(--electric-cyan);
    font-weight: 500;
  }

  .toc-link.is-active .toc-number {
    color: var(--electric-cyan);
  }

  .toc-number {
    font-family: 'JetBrains Mono Variable', monospace;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    min-width: 1rem;
    transition: color var(--duration-fast) var(--ease-smooth);
  }

  .toc-text {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Desktop: show sidebar, hide mobile */
  @media (min-width: 1024px) {
    .toc-mobile {
      display: none;
    }
    .toc-desktop {
      display: block;
    }
  }

  /* ============================================
     Dark Mode Enhancements
     ============================================ */
  :global([data-mode="dark"]) .toc-desktop,
  :global([data-mode="dark"]) .toc-mobile {
    background: var(--jazz-smoke);
    border-color: var(--color-border);
  }

  :global([data-mode="dark"]) .toc-header,
  :global([data-mode="dark"]) .toc-summary {
    background: var(--jazz-slate);
  }

  :global([data-mode="dark"]) .toc-link.is-active {
    background: rgba(0, 217, 255, 0.1);
  }
</style>

<script>
  // Active section tracking with Intersection Observer
  document.addEventListener('DOMContentLoaded', () => {
    const tocLinks = document.querySelectorAll('[data-toc-link]');
    if (tocLinks.length === 0) return;

    // Get all heading IDs from TOC links
    const headingIds = Array.from(tocLinks).map(
      link => link.getAttribute('data-heading-id')
    ).filter(Boolean) as string[];

    // Find corresponding headings in the document
    const headings = headingIds
      .map(id => document.getElementById(id))
      .filter((h): h is HTMLElement => h !== null);

    if (headings.length === 0) return;

    // Track which heading is currently active
    let activeId: string | null = null;

    // Update active state on all matching TOC links
    const setActiveLink = (id: string | null) => {
      if (id === activeId) return;
      activeId = id;

      tocLinks.forEach(link => {
        const linkId = link.getAttribute('data-heading-id');
        if (linkId === id) {
          link.classList.add('is-active');
        } else {
          link.classList.remove('is-active');
        }
      });
    };

    // Create Intersection Observer
    const observerOptions: IntersectionObserverInit = {
      rootMargin: '-80px 0px -70% 0px',
      threshold: 0
    };

    const visibleHeadings = new Set<string>();

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const id = entry.target.id;
        if (entry.isIntersecting) {
          visibleHeadings.add(id);
        } else {
          visibleHeadings.delete(id);
        }
      });

      // Find the topmost visible heading
      if (visibleHeadings.size > 0) {
        // Get the first heading in document order that's visible
        for (const heading of headings) {
          if (visibleHeadings.has(heading.id)) {
            setActiveLink(heading.id);
            break;
          }
        }
      }
    }, observerOptions);

    // Observe all headings
    headings.forEach(heading => observer.observe(heading));

    // Smooth scroll on click
    tocLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const id = link.getAttribute('data-heading-id');
        if (!id) return;

        const target = document.getElementById(id);
        if (!target) return;

        // Smooth scroll to heading
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Update URL hash without scrolling
        history.pushState(null, '', `#${id}`);

        // Immediately set as active
        setActiveLink(id);
      });
    });

    // Handle initial hash in URL
    if (window.location.hash) {
      const id = window.location.hash.slice(1);
      if (headingIds.includes(id)) {
        setActiveLink(id);
      }
    } else if (headings.length > 0) {
      // Default to first heading if at top of page
      const scrollTop = window.scrollY || document.documentElement.scrollTop;
      if (scrollTop < 100) {
        setActiveLink(headings[0].id);
      }
    }
  });
</script>
