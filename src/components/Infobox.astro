---
/**
 * Infobox Component - Jazz Club Aesthetic
 * Wikipedia-style sidebar with art deco influences
 * Features brass accents, warm lighting effects, and electric hover states
 */

interface Props {
  title: string;
  data: Record<string, unknown>;
}

const { title, data } = Astro.props;

// Extract infobox data
const infobox = data.infobox as Record<string, unknown> | undefined;
const spotifyData = data.spotify_data as { popularity?: number; followers?: number; url?: string; id?: string } | undefined;

// Determine accent color based on artist type
const getTypeAccent = (background?: string) => {
  switch (background) {
    case 'solo_singer':
      return { accent: 'singer', color: 'var(--jazz-amber)', label: 'Vocalist' };
    case 'instrumentalist':
      return { accent: 'instrumentalist', color: 'var(--electric-cyan)', label: 'Instrumentalist' };
    case 'group_or_band':
      return { accent: 'band', color: 'var(--electric-purple)', label: 'Group' };
    default:
      return { accent: 'default', color: 'var(--jazz-brass)', label: null };
  }
};

const background = infobox?.background as string | undefined;
const typeInfo = getTypeAccent(background);

// Format numbers with commas
const formatNumber = (num: number | undefined) => num?.toLocaleString() ?? 'N/A';

// Format date for display
const formatDate = (date: string | undefined) => {
  if (!date) return null;
  try {
    const d = new Date(date);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  } catch {
    return date;
  }
};

// Extract key data with fallbacks
const birthName = (data.birth_name || infobox?.birth_name) as string | undefined;
const birthDate = (data.birth_date || infobox?.born) as string | undefined;
const birthPlace = data.birth_place as string | undefined;
const deathDate = (data.death_date || infobox?.died) as string | undefined;
const genres = (data.genres || []) as string[];
const instruments = (data.instruments || []) as string[];
const yearsActive = data.years_active as string | undefined;
const occupation = (data.occupation || []) as string[];
const recordLabels = (data.record_labels || []) as string[];
const aliases = (data.aliases || data.also_known_as || []) as string[];
const spouse = (data.spouse || []) as string[];
const rawAssociatedActs = (data.associated_acts || []) as Array<string | { name?: string }>;
const associatedActs = rawAssociatedActs.map(act =>
  typeof act === 'string' ? act : (act.name || '')
).filter(Boolean);

// Get image path
const rawImagePath = (data.image_path || infobox?.image) as string | undefined;
let portraitFilename: string | undefined;
if (rawImagePath) {
  portraitFilename = rawImagePath.split('/').pop();
}

// External URLs
const externalUrls = data.external_urls as { spotify?: string; wikipedia?: string; musicbrainz?: string } | undefined;

// Helper to convert genre/instrument to slug
const toSlug = (text: string) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
---

<aside class={`infobox infobox--${typeInfo.accent}`}>
  <!-- Header with art deco styling -->
  <header class="infobox__header">
    <h2 class="infobox__title">{title}</h2>
    {typeInfo.label && (
      <span class="infobox__type-badge">{typeInfo.label}</span>
    )}
  </header>

  <!-- Portrait with frame effect -->
  <div class="infobox__portrait">
    {portraitFilename ? (
      <div class="portrait-container">
        <img
          src={`/portraits/${portraitFilename}`}
          alt={title}
          class="portrait-image"
          loading="lazy"
          decoding="async"
        />
        <div class="portrait-fallback">
          <span class="portrait-icon">&#9835;</span>
          <span class="portrait-text">No image</span>
        </div>
      </div>
    ) : (
      <div class="portrait-placeholder">
        <span class="portrait-icon">&#9835;</span>
        <span class="portrait-text">No image available</span>
      </div>
    )}
  </div>

  <!-- Info Table -->
  <div class="infobox__content">
    <table class="infobox__table">
      <tbody>
        {birthName && (
          <tr>
            <th>Birth name</th>
            <td>{birthName}</td>
          </tr>
        )}

        {aliases.length > 0 && (
          <tr>
            <th>Also known as</th>
            <td>{aliases.slice(0, 3).join(', ')}{aliases.length > 3 ? '...' : ''}</td>
          </tr>
        )}

        {birthDate && (
          <tr>
            <th>Born</th>
            <td>
              {formatDate(birthDate)}
              {birthPlace && <span class="text-muted"><br />{birthPlace}</span>}
            </td>
          </tr>
        )}

        {deathDate && (
          <tr>
            <th>Died</th>
            <td>{formatDate(deathDate)}</td>
          </tr>
        )}

        {genres.length > 0 && (
          <tr>
            <th>Genres</th>
            <td>
              <div class="tag-list">
                {genres.slice(0, 4).map(genre => (
                  <a href={`/genres/${toSlug(genre)}`} class="tag">{genre}</a>
                ))}
                {genres.length > 4 && <span class="tag-more">+{genres.length - 4}</span>}
              </div>
            </td>
          </tr>
        )}

        {instruments.length > 0 && (
          <tr>
            <th>Instruments</th>
            <td>
              <div class="tag-list">
                {instruments.slice(0, 3).map(instrument => (
                  <a href={`/instruments/${toSlug(instrument)}`} class="tag">{instrument}</a>
                ))}
                {instruments.length > 3 && <span class="tag-more">+{instruments.length - 3}</span>}
              </div>
            </td>
          </tr>
        )}

        {occupation.length > 0 && (
          <tr>
            <th>Occupation</th>
            <td>{occupation.slice(0, 3).join(', ')}</td>
          </tr>
        )}

        {yearsActive && (
          <tr>
            <th>Years active</th>
            <td class="font-mono">{yearsActive}</td>
          </tr>
        )}

        {recordLabels.length > 0 && (
          <tr>
            <th>Labels</th>
            <td>{recordLabels.slice(0, 3).join(', ')}{recordLabels.length > 3 ? '...' : ''}</td>
          </tr>
        )}

        {associatedActs.length > 0 && (
          <tr>
            <th>Associated</th>
            <td>{associatedActs.slice(0, 3).join(', ')}{associatedActs.length > 3 ? '...' : ''}</td>
          </tr>
        )}

        {spouse.length > 0 && (
          <tr>
            <th>Spouse(s)</th>
            <td>{spouse.join(', ')}</td>
          </tr>
        )}
      </tbody>
    </table>

    <!-- Spotify Section -->
    {spotifyData && (spotifyData.popularity !== undefined || spotifyData.followers) && (
      <div class="spotify-section">
        <div class="spotify-header">
          <svg class="spotify-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
          </svg>
          <span>Spotify</span>
        </div>

        {spotifyData.popularity !== undefined && (
          <div class="spotify-stat">
            <span class="spotify-label">Popularity</span>
            <div class="popularity-bar">
              <div class="popularity-fill" style={`--popularity: ${spotifyData.popularity}%`}></div>
              <span class="popularity-value">{spotifyData.popularity}</span>
            </div>
          </div>
        )}

        {spotifyData.followers && (
          <div class="spotify-stat">
            <span class="spotify-label">Followers</span>
            <span class="spotify-value font-mono">{formatNumber(spotifyData.followers)}</span>
          </div>
        )}

        {spotifyData.url && (
          <a href={spotifyData.url} target="_blank" rel="noopener noreferrer" class="spotify-link">
            Listen on Spotify
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          </a>
        )}
      </div>
    )}

    <!-- External Links -->
    {externalUrls && (externalUrls.wikipedia || externalUrls.musicbrainz || externalUrls.spotify) && (
      <div class="external-links">
        {externalUrls.wikipedia && (
          <a href={externalUrls.wikipedia} target="_blank" rel="noopener noreferrer" class="external-link" title="Wikipedia">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12.09 13.119c-.936 1.932-2.217 4.548-2.853 5.728-.616 1.074-1.127.931-1.532.029-1.406-3.321-4.293-9.144-5.651-12.409-.251-.601-.441-.987-.619-1.139-.181-.15-.554-.24-1.122-.271C.103 5.033 0 4.982 0 4.898v-.455l.052-.045c.924-.005 5.401 0 5.401 0l.051.045v.434c0 .119-.075.176-.225.176l-.564.031c-.485.029-.727.164-.727.436 0 .135.053.33.166.601 1.082 2.646 4.818 10.521 4.818 10.521l.136.046 2.411-4.81-.482-1.067-1.658-3.264s-.318-.654-.428-.872c-.728-1.443-.712-1.518-1.447-1.617-.207-.023-.313-.05-.313-.149v-.468l.06-.045h4.292l.113.037v.451c0 .105-.076.15-.227.15l-.308.047c-.792.061-.661.381-.136 1.422l1.582 3.252 1.758-3.504c.293-.64.233-.801.111-.947-.07-.084-.305-.22-.812-.24l-.201-.021c-.052 0-.098-.015-.145-.051-.045-.031-.067-.076-.067-.129v-.427l.061-.045c1.247-.008 4.043 0 4.043 0l.059.045v.436c0 .121-.059.178-.193.178-.646.03-.782.095-1.023.439-.12.186-.375.589-.646 1.039l-2.301 4.273-.065.135 2.792 5.712.17.048 4.396-10.438c.154-.422.129-.722-.064-.895-.197-.172-.346-.273-.857-.295l-.42-.016c-.061 0-.105-.014-.152-.045-.043-.029-.072-.075-.072-.119v-.436l.059-.045h4.961l.041.045v.437c0 .119-.074.18-.209.18-.648.03-1.127.18-1.443.421-.314.255-.557.616-.736 1.067 0 0-4.043 9.258-5.426 12.339-.525 1.007-1.053.917-1.503-.031-.571-1.171-1.773-3.786-2.646-5.71l.053-.036z"/>
            </svg>
          </a>
        )}
        {externalUrls.musicbrainz && (
          <a href={externalUrls.musicbrainz} target="_blank" rel="noopener noreferrer" class="external-link" title="MusicBrainz">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M0 0v24h24V0H0zm5.441 4.16h2.248v4.523a3.59 3.59 0 0 1 2.29-.908c2.455 0 4.283 2.124 4.283 4.89 0 2.767-1.828 4.891-4.283 4.891a3.618 3.618 0 0 1-2.291-.91v.682H5.44v-13.17zm8.168 4.139h2.247v.91a3.589 3.589 0 0 1 2.291-.91c2.455 0 4.282 2.124 4.282 4.89 0 2.767-1.827 4.891-4.282 4.891a3.618 3.618 0 0 1-2.291-.91v4.17H13.61V8.298zm-5.92 5.543c0-1.63-.97-2.953-2.168-2.953-1.2 0-2.17 1.322-2.17 2.953 0 1.631.97 2.953 2.17 2.953 1.199 0 2.168-1.322 2.168-2.953zm8.167 0c0-1.63-.97-2.953-2.168-2.953-1.199 0-2.17 1.322-2.17 2.953 0 1.631.971 2.953 2.17 2.953 1.199 0 2.168-1.322 2.168-2.953z"/>
            </svg>
          </a>
        )}
      </div>
    )}
  </div>
</aside>

<style>
  /* Base infobox styling */
  .infobox {
    width: 100%;
    max-width: 20rem;
    background: var(--color-bg-infobox);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    font-size: 0.875rem;
    box-shadow: var(--shadow-card);
    transition: box-shadow var(--duration-normal) var(--ease-smooth);
    /* Sticky positioning for desktop */
    position: sticky;
    top: 5rem;
    align-self: start;
  }

  .infobox:hover {
    box-shadow: var(--shadow-elevated);
  }

  /* Header styling */
  .infobox__header {
    background: linear-gradient(135deg, var(--color-bg-nav) 0%, var(--color-bg-elevated) 100%);
    padding: 0.75rem 1rem;
    border-bottom: 2px solid var(--jazz-brass);
    text-align: center;
    position: relative;
  }

  .infobox__header::before {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent 0%, var(--jazz-amber) 50%, transparent 100%);
  }

  .infobox__title {
    font-family: 'Playfair Display Variable', Georgia, serif;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text-heading);
    margin: 0;
    letter-spacing: -0.01em;
  }

  .infobox__type-badge {
    display: inline-block;
    margin-top: 0.25rem;
    padding: 0.125rem 0.5rem;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    border-radius: 9999px;
    background: var(--color-accent-light);
    color: var(--color-accent);
    border: 1px solid var(--color-border-accent);
  }

  /* Artist type accent colors */
  .infobox--singer .infobox__header { border-bottom-color: var(--jazz-amber); }
  .infobox--singer .infobox__type-badge {
    background: rgba(212, 162, 84, 0.15);
    color: var(--jazz-amber);
    border-color: var(--jazz-amber);
  }

  .infobox--instrumentalist .infobox__header { border-bottom-color: var(--electric-cyan); }
  .infobox--instrumentalist .infobox__type-badge {
    background: rgba(0, 217, 255, 0.15);
    color: var(--electric-cyan);
    border-color: var(--electric-cyan);
  }

  .infobox--band .infobox__header { border-bottom-color: var(--electric-purple); }
  .infobox--band .infobox__type-badge {
    background: rgba(157, 78, 221, 0.15);
    color: var(--electric-purple);
    border-color: var(--electric-purple);
  }

  /* Portrait styling */
  .infobox__portrait {
    aspect-ratio: 3 / 4;
    overflow: hidden;
    position: relative;
    background: var(--color-bg-nav);
  }

  .portrait-container {
    width: 100%;
    height: 100%;
    position: relative;
  }

  .portrait-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--duration-slow) var(--ease-jazz);
  }

  .infobox:hover .portrait-image {
    transform: scale(1.03);
  }

  .portrait-fallback,
  .portrait-placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-nav);
    color: var(--color-text-muted);
  }

  .portrait-fallback {
    display: none;
  }

  .portrait-icon {
    font-size: 3rem;
    opacity: 0.3;
    margin-bottom: 0.5rem;
  }

  .portrait-text {
    font-size: 0.75rem;
    opacity: 0.6;
  }

  /* Content area */
  .infobox__content {
    padding: 0;
  }

  /* Table styling */
  .infobox__table {
    width: 100%;
    border-collapse: collapse;
  }

  .infobox__table th,
  .infobox__table td {
    padding: 0.5rem 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border-light);
    vertical-align: top;
    color: var(--color-text);
  }

  .infobox__table th {
    width: 5.5rem;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-secondary);
    background: var(--color-bg-nav);
  }

  .infobox__table tr:last-child th,
  .infobox__table tr:last-child td {
    border-bottom: none;
  }

  /* Tags */
  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }

  .tag {
    display: inline-block;
    padding: 0.125rem 0.375rem;
    font-size: 0.75rem;
    background: var(--color-tag-bg);
    border: 1px solid var(--color-tag-border);
    border-radius: 9999px;
    color: var(--color-link);
    text-decoration: none;
    transition: all var(--duration-fast) var(--ease-smooth);
  }

  .tag:hover {
    background: var(--color-accent-light);
    border-color: var(--color-border-accent);
    color: var(--color-link-hover);
  }

  .tag-more {
    display: inline-block;
    padding: 0.125rem 0.375rem;
    font-size: 0.7rem;
    color: var(--color-text-muted);
  }

  .text-muted {
    color: var(--color-text-muted);
    font-size: 0.8em;
  }

  .font-mono {
    font-family: 'JetBrains Mono Variable', monospace;
    font-size: 0.9em;
  }

  /* Spotify section */
  .spotify-section {
    padding: 0.75rem;
    background: linear-gradient(135deg, rgba(30, 215, 96, 0.08) 0%, rgba(30, 215, 96, 0.02) 100%);
    border-top: 1px solid var(--color-border-light);
  }

  .spotify-header {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #1DB954;
    margin-bottom: 0.5rem;
  }

  .spotify-icon {
    width: 1rem;
    height: 1rem;
  }

  .spotify-stat {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.375rem 0;
  }

  .spotify-label {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
  }

  .spotify-value {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text);
  }

  /* Popularity bar */
  .popularity-bar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
    max-width: 8rem;
  }

  .popularity-fill {
    flex: 1;
    height: 0.375rem;
    background: var(--color-border-light);
    border-radius: 9999px;
    overflow: hidden;
    position: relative;
  }

  .popularity-fill::after {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: var(--popularity);
    background: linear-gradient(90deg, #1DB954 0%, var(--electric-cyan) 100%);
    border-radius: 9999px;
    transition: width var(--duration-slow) var(--ease-jazz);
  }

  .popularity-value {
    font-family: 'JetBrains Mono Variable', monospace;
    font-size: 0.75rem;
    font-weight: 600;
    color: #1DB954;
    min-width: 1.5rem;
  }

  .spotify-link {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;
    margin-top: 0.5rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: #1DB954;
    background: rgba(30, 215, 96, 0.1);
    border: 1px solid rgba(30, 215, 96, 0.3);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--duration-fast) var(--ease-smooth);
  }

  .spotify-link:hover {
    background: rgba(30, 215, 96, 0.2);
    border-color: #1DB954;
  }

  /* External links */
  .external-links {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem;
    border-top: 1px solid var(--color-border-light);
    background: var(--color-bg-nav);
  }

  .external-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: var(--radius-md);
    color: var(--color-text-muted);
    transition: all var(--duration-fast) var(--ease-smooth);
  }

  .external-link:hover {
    color: var(--color-link-hover);
    background: var(--color-accent-light);
  }

  .external-link svg {
    width: 1rem;
    height: 1rem;
  }

  /* Responsive - center on mobile */
  @media (max-width: 768px) {
    .infobox {
      position: relative;
      top: 0;
      margin: 0 auto;
    }
  }

  /* Dark mode enhancements */
  :global([data-mode="dark"]) .infobox {
    background: var(--jazz-smoke);
    border-color: var(--color-border);
  }

  :global([data-mode="dark"]) .infobox__header {
    background: linear-gradient(135deg, var(--jazz-slate) 0%, var(--jazz-smoke) 100%);
  }

  :global([data-mode="dark"]) .infobox__table th {
    background: var(--jazz-slate);
  }

  :global([data-mode="dark"]) .spotify-section {
    background: linear-gradient(135deg, rgba(30, 215, 96, 0.12) 0%, rgba(30, 215, 96, 0.04) 100%);
  }

  :global([data-mode="dark"]) .external-links {
    background: var(--jazz-slate);
  }
</style>

<script>
  // Handle portrait image loading errors
  document.addEventListener('DOMContentLoaded', () => {
    const portraitImages = document.querySelectorAll('.portrait-image');
    portraitImages.forEach(img => {
      img.addEventListener('error', () => {
        const container = img.closest('.portrait-container');
        if (container) {
          const fallback = container.querySelector('.portrait-fallback');
          if (fallback) {
            (img as HTMLElement).style.display = 'none';
            (fallback as HTMLElement).style.display = 'flex';
          }
        }
      });
    });
  });
</script>
