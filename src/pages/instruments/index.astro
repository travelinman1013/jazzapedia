---
/**
 * Instruments Index - Browse all instruments
 * Uses D1/SQLite database for data
 */
import Layout from '../../layouts/Layout.astro';
import { getDatabase } from '../../lib/db';

// Get database adapter (works with both D1 and SQLite)
const db = await getDatabase(Astro.locals);

// Set cache headers
Astro.response.headers.set('Cache-Control', 'public, max-age=3600, stale-while-revalidate=86400');

interface Instrument {
  id: number;
  name: string;
  slug: string;
  artist_count: number;
}

let instruments: Instrument[] = [];
let totalArtists = 0;
let errorMessage = '';

if (db) {
  try {
    // Get all instruments from lookup table
    const { results } = await db
      .prepare('SELECT id, name, slug, artist_count FROM instruments ORDER BY artist_count DESC')
      .all();
    instruments = results as Instrument[];

    // Get total artist count
    const countResult = await db
      .prepare('SELECT COUNT(*) as count FROM artists')
      .first();
    totalArtists = (countResult as { count: number })?.count || 0;
  } catch (error) {
    console.error('Error loading instruments:', error);
    errorMessage = 'Failed to load instruments.';
  }
} else {
  errorMessage = 'Database not available.';
}

// Group instruments by first letter for alphabetical sections
const instrumentsByLetter = new Map<string, Instrument[]>();
instruments.forEach(instrument => {
  const letter = instrument.name.charAt(0).toUpperCase();
  if (!instrumentsByLetter.has(letter)) {
    instrumentsByLetter.set(letter, []);
  }
  instrumentsByLetter.get(letter)!.push(instrument);
});

const sortedLetters = Array.from(instrumentsByLetter.keys()).sort();

// Stats
const totalInstruments = instruments.length;
const topInstrument = instruments[0];
---

<Layout title="Instruments">
  <div class="article-content">
    <h1>Browse by Instrument</h1>

    {errorMessage ? (
      <p class="text-red-600">{errorMessage}</p>
    ) : (
      <>
        <p class="text-wiki-text-secondary mb-6">
          Explore <strong>{totalInstruments}</strong> instruments across <strong>{totalArtists.toLocaleString()}</strong> artists.
          {topInstrument && topInstrument.artist_count > 0 && (
            <>
              The most common is <a href={`/instruments/${topInstrument.slug}`} class="text-wiki-link">{topInstrument.name}</a> with {topInstrument.artist_count.toLocaleString()} artists.
            </>
          )}
        </p>

        <!-- Top Instruments Quick Links -->
        <div class="bg-wiki-accent-light border border-wiki-border rounded p-4 mb-8">
          <h2 class="text-lg font-serif mb-3">Popular Instruments</h2>
          <div class="flex flex-wrap gap-2">
            {instruments.filter(i => i.artist_count > 0).slice(0, 15).map(instrument => (
              <a
                href={`/instruments/${instrument.slug}`}
                class="inline-flex items-center px-3 py-1.5 bg-white border border-wiki-border rounded text-sm hover:bg-wiki-bg hover:border-wiki-link transition-colors"
              >
                <span class="text-wiki-link font-medium">{instrument.name}</span>
                <span class="ml-2 text-wiki-text-muted text-xs">({instrument.artist_count.toLocaleString()})</span>
              </a>
            ))}
          </div>
        </div>

        <!-- Instruments by Letter -->
        <div class="space-y-6">
          {sortedLetters.map(letter => {
            const letterInstruments = instrumentsByLetter.get(letter)!;
            return (
              <section>
                <h2 class="text-xl font-serif border-b border-wiki-border pb-2 mb-2">
                  {letter}
                  <span class="text-wiki-text-muted text-sm font-normal ml-2">
                    ({letterInstruments.length})
                  </span>
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                  {letterInstruments.map(instrument => (
                    <a
                      href={`/instruments/${instrument.slug}`}
                      class="flex items-center justify-between p-2 hover:bg-wiki-accent-light rounded border border-transparent hover:border-wiki-border-light transition-colors"
                    >
                      <span class="text-wiki-link">{instrument.name}</span>
                      <span class="text-wiki-text-muted text-sm">{instrument.artist_count.toLocaleString()} artists</span>
                    </a>
                  ))}
                </div>
              </section>
            );
          })}
        </div>
      </>
    )}
  </div>
</Layout>
