# Jazzapedia Monorepo Docker Compose
# Orchestrates scraper, web, and nginx with shared SQLite database
#
# Architecture:
#   scraper → writes to SQLite (/data/jazzapedia.db)
#   web     → reads from SQLite (read-only mount)
#   nginx   → reverse proxy + serves portraits
#
# Usage:
#   docker-compose up -d --build          # Build and start all services
#   docker-compose up -d web nginx        # Start web only (for testing)
#   docker-compose logs -f scraper        # Watch scraper logs
#   docker-compose exec scraper npm start # Run scraper manually

services:
  # ============================================
  # WWOZ Scraper - Writes to SQLite
  # ============================================
  scraper:
    build:
      context: .
      dockerfile: apps/scraper/Dockerfile
    container_name: jazzapedia-scraper
    restart: unless-stopped
    environment:
      - CONFIG_PATH=/app/apps/scraper/config/config.yaml
      - DATABASE_PATH=/data/jazzapedia.db
      - STATE_PATH=/app/state
      - NODE_ENV=production
      - TZ=America/Chicago
    volumes:
      # Shared SQLite database (scraper has read-write access)
      - jazzapedia-data:/data
      # Scraper configuration
      - ./config/scraper:/app/apps/scraper/config:ro
      # Persistent state for archiver (bind mount for host launchd watcher access)
      - ./scraper-state:/app/state
      # Obsidian vault archives (symlinked from ./archives to Obsidian vault)
      - ${OBSIDIAN_ARCHIVES:-./archives}:/app/archives
      # Artist discovery output directories (mounted from host Obsidian vault)
      - /Users/maxwell/LETSGO/MaxVault/01_Projects/PersonalArtistWiki/Artists:/vault/Artists
      - /Users/maxwell/LETSGO/MaxVault/03_Resources/source_material/ArtistPortraits:/vault/ArtistPortraits
    networks:
      - jazzapedia-network

  # ============================================
  # Jazzapedia Web - Astro SSR Application
  # ============================================
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: jazzapedia-web
    restart: unless-stopped
    environment:
      - DEPLOY_TARGET=docker
      - DATABASE_PATH=/data/jazzapedia.db
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=4321
    volumes:
      # Shared SQLite database (web has read-only access)
      - jazzapedia-data:/data:ro
    stop_grace_period: 10s
    expose:
      - "4321"
    networks:
      - jazzapedia-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:4321/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # Nginx Reverse Proxy & Static File Server
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: jazzapedia-nginx
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      # Nginx configuration
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # Portrait images served directly by nginx
      - jazzapedia-portraits:/var/www/portraits:ro
    depends_on:
      web:
        condition: service_healthy
    networks:
      - jazzapedia-network

# Named volumes for data persistence
volumes:
  # Shared SQLite database
  jazzapedia-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data
  # Artist portraits
  jazzapedia-portraits:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/portraits
  # Note: scraper-state is now a bind mount (./scraper-state) for host launchd watcher access

networks:
  jazzapedia-network:
    driver: bridge
